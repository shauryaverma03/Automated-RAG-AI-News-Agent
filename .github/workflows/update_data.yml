name: Hourly News Scraper

on:
  schedule:
    - cron: '0 * * * *'  # Runs at minute 0 of every hour
  workflow_dispatch:      # Allows you to click "Run Now" manually

jobs:
  scrape-and-embed:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Critical: Allows the bot to push changes
    
    steps: 
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch full history to avoid conflicts
        
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: ðŸ“¦ Install Libraries
        run: pip install -r requirements.txt
        
      - name: ðŸ” Run Automation Script
        env: 
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          HF_TOKEN: ${{ secrets. HF_TOKEN }}
          HF_REPO_ID: ${{ secrets.HF_REPO_ID }}
        run: python ingest_and_push.py
        
      # --- SAVE BOTH JSON FILES TO GITHUB ---
      - name: ðŸ’¾ Commit JSON Data to Repository
        run: |
          # 1. Configure Git identity
          git config --local user.name "shauryaverma03"
          git config --local user.email "shauryaverma036@gmail.com"
          
          # 2. Pull latest changes to avoid conflicts
          git pull origin main --rebase || echo "No remote changes to pull"
          
          # 3. Add BOTH JSON files (root + React public folder)
          git add knowledge_base.json
          git add tech-news-frontend/public/knowledge_base.json
          
          # 4. Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit - knowledge base already up to date"
          else
            # 5. Commit with timestamp
            git commit -m "ðŸ“š Auto-update: News data refreshed - $(date +'%Y-%m-%d %H:%M UTC')"
            
            # 6. Push to GitHub
            git push origin main
            echo "âœ… Successfully pushed updates to GitHub"
          fi
      
      - name: ðŸ“Š Job Summary
        if: always()
        run: |
          echo "### ðŸŽ‰ News Ingestion Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Execution Time** | $(date +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| **Python Version** | 3.10 |" >> $GITHUB_STEP_SUMMARY
          echo "| **Files Updated** | 2 (root + React public) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Next Run** | In 1 hour |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check file sizes
          if [ -f knowledge_base.json ]; then
            ROOT_SIZE=$(du -h knowledge_base.json | cut -f1)
            echo "| **Root JSON Size** | $ROOT_SIZE |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f tech-news-frontend/public/knowledge_base.json ]; then
            REACT_SIZE=$(du -h tech-news-frontend/public/knowledge_base.json | cut -f1)
            echo "| **React JSON Size** | $REACT_SIZE |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status**: Success" >> $GITHUB_STEP_SUMMARY